# STORY-006: Session Context Protocol — 跨会话项目状态自动感知

- **Priority**: 5 (Impact 5 / Effort 3)
- **Agent**: System Architect → Senior Developer
- **Release**: TBD
- **Depends on**: None

## Background

PactKit 部署的 CLAUDE.md 只包含静态规则（6 个 constitution 模块）和命令路由表。新 session 启动时，agent 读到的是「怎么做」但不知道「在做什么」。

每个 PDCA 命令各自在 Phase 0/1 手动读取 spec 和 board，但这要求用户主动发起命令。对于冷启动场景（新 session 打开项目、context 被压缩后恢复、换人接手），agent 无法自主理解项目当前状态。

**核心问题**: Opus 4.6 原生的 plan 能力已经很强，PactKit 的规则层（thinking block, atomic tools 等）与 Opus 原生行为高度重叠。PactKit 的真正差异化在于**跨会话的工程记忆**——而目前这个能力只是「文件存在磁盘上」的被动状态，没有主动加载机制。

## Requirements

### R1: Project Context File Generation (MUST)
`/project-done` 命令在 Phase 4 (Git Commit) 之后，MUST 生成/更新 `docs/product/context.md`，内容包括：
- **Current Sprint**: 从 `sprint_board.md` 提取 In Progress 和 Backlog 条目
- **Recent Completions**: 最近 3 个已完成的 Story（从 Done 区或 archive 提取）
- **Active Branches**: `git branch --list 'feature/*' 'fix/*'` 的输出
- **Key Decisions**: 从 `lessons.md` 提取最近 5 条记录
- **Architecture Snapshot**: `code_graph.mmd` 的最后更新时间

### R2: CLAUDE.md Auto-reference (MUST)
部署的 CLAUDE.md（classic 模式）MUST 在 constitution 引用之后追加一行：
```
@./docs/product/context.md
```
使用项目相对路径（`./`），使得 Claude Code 自动加载项目上下文。若 `context.md` 不存在，Claude Code 会静默忽略（@import 的已有行为）。

### R3: Context File Update Triggers (MUST)
以下命令 MUST 在执行结束时更新 `context.md`：
- `/project-done` — 在 commit 之后
- `/project-plan` — 在创建 Spec 和 Board entry 之后
- `/project-init` — 在初始化完成之后

其他命令（act, check, trace 等）SHOULD NOT 更新 context.md（避免频繁写入）。

### R4: Context File Format (MUST)
`context.md` MUST 使用以下固定格式，便于 agent 快速解析：

```markdown
# Project Context (Auto-generated)
> Last updated: {ISO timestamp} by {command}

## Sprint Status
{从 sprint_board.md 提取的 In Progress / Backlog 摘要}

## Recent Completions
{最近 3 个完成的 Story，单行摘要}

## Active Branches
{git branch 输出}

## Key Decisions
{最近 5 条 lessons}

## Next Recommended Action
{基于 board 状态的建议：有 In Progress → `/project-act STORY-XXX`，全是 Backlog → `/project-plan`，空 board → `/project-design`}
```

### R5: Lessons Auto-append (MUST)
`/project-done` 的 Phase 3 MUST 自动向 `docs/architecture/governance/lessons.md` 追加一条记录，格式：
```
| {date} | {one-line summary of what was learned} | {STORY-ID} |
```
即使没有 Memory MCP，lessons.md 也 MUST 被更新。Memory MCP 是增强，不是唯一路径。

### R6: Plugin Mode Context (SHOULD)
Plugin 模式部署的 CLAUDE.md（inline 格式）SHOULD 包含一段说明，引导用户创建 `docs/product/context.md`：
```
> TIP: Run `/project-init` to set up project governance and enable cross-session context.
```

## Acceptance Criteria

### Scenario 1: Done generates context.md
**Given** a project with `sprint_board.md` containing 1 In Progress story and 2 Backlog stories
**When** `/project-done STORY-XXX` completes
**Then** `docs/product/context.md` exists with Sprint Status showing 1 in-progress and 2 backlog items, and Next Recommended Action suggests `/project-act`

### Scenario 2: CLAUDE.md references context.md
**Given** `pactkit init` is run in classic mode
**When** deployment completes
**Then** the generated `~/.claude/CLAUDE.md` contains the line `@./docs/product/context.md` after the rule imports

### Scenario 3: Cold start with context
**Given** a project with `context.md` generated by a previous session
**When** a new Claude Code session opens the project
**Then** the agent reads CLAUDE.md → auto-loads context.md → has awareness of sprint status, recent completions, and recommended next action without user prompting

### Scenario 4: Lessons auto-appended
**Given** `/project-done STORY-005` completes
**When** Phase 3 executes
**Then** `lessons.md` has a new row with today's date, a summary, and STORY-005 as context

### Scenario 5: Context.md missing gracefully
**Given** a project where `context.md` does not yet exist
**When** CLAUDE.md is loaded by Claude Code
**Then** no error occurs (the `@./docs/product/context.md` import is silently skipped)

### Scenario 6: Plan updates context
**Given** `/project-plan` creates STORY-007 with 4 tasks
**When** Phase 3 completes
**Then** `context.md` is updated with STORY-007 in the Sprint Status section

## Target Call Chain

```
# Done command flow (primary trigger):
Done Phase 4 (Git Commit)
  → _generate_context_file()
    → read sprint_board.md → extract sections
    → read lessons.md → extract recent entries
    → git branch --list → active branches
    → write docs/product/context.md

# Deployer flow (CLAUDE.md reference):
deployer.py → _deploy_classic()
  → _deploy_claude_md()
    → CLAUDE_MD_TEMPLATE now includes @./docs/product/context.md

# Prompt changes:
commands.py → project-done.md → Phase 4.5 (new): generate context
commands.py → project-plan.md → Phase 3.5 (new): generate context
commands.py → project-init.md → Phase 6.5 (new): generate context
```

## Implementation Notes

1. **context.md 是 prompt engineering，不是 Python 代码**: 主要改动在 `commands.py`（playbook 文本）和 `rules.py`（CLAUDE_MD_TEMPLATE）。context.md 的生成逻辑写在 playbook 里，由 agent 在运行时执行（读 board → 组装 markdown → 写文件），不需要新的 Python 模块。

2. **CLAUDE_MD_TEMPLATE 改动**: 在 `rules.py` 的模板末尾加一行 `@./docs/product/context.md`。这是 deployer.py 部署时生成的内容，不影响 plugin 模式（plugin 模式用 inline CLAUDE.md）。

3. **向后兼容**: context.md 不存在时 @import 静默失败，对未初始化的项目零影响。
