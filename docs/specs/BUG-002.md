# BUG-002: Plugin Mode Deploys Hardcoded ~/.claude/skills/ Paths

| Field       | Value |
|-------------|-------|
| ID          | BUG-002 |
| Type        | Bug |
| Priority    | P1 |
| Status      | Done |
| Release     | 1.1.2 |
| Created     | 2025-02-13 |

## Summary

Plugin and marketplace deployment modes copy the same SKILL.md, command, and workflow templates as classic mode. These templates hardcode `~/.claude/skills/` paths which are only correct for classic deployment. In plugin mode, skills are served from `${CLAUDE_PLUGIN_ROOT}/skills/`, making all 34 script path references wrong.

## Root Cause

`_deploy_skills()`, `_deploy_commands()`, and `_deploy_claude_md_inline()` in `deployer.py` write templates verbatim without adjusting paths for the target deployment mode. Classic and plugin modes share the same template content despite having different runtime directory structures.

## Target Call Chain

```
pactkit init --format plugin
  → cli.py main() → deploy(format="plugin")
  → _deploy_plugin()
    → _deploy_skills(skills_dir, all_skills)        ← writes SKILL.md with ~/.claude/skills/
    → _deploy_commands(commands_dir, all_commands)   ← writes commands with ~/.claude/skills/
    → _deploy_claude_md_inline(plugin_root)          ← writes CLAUDE.md with ~/.claude/skills/ in rules
```

## Requirements

- R1: `_deploy_skills()` MUST accept an optional `skills_prefix` parameter (default: `~/.claude/skills`).
- R2: `_deploy_commands()` MUST accept an optional `skills_prefix` parameter (default: `~/.claude/skills`).
- R3: `_deploy_plugin()` MUST pass `skills_prefix="${CLAUDE_PLUGIN_ROOT}/skills"` to both `_deploy_skills()` and `_deploy_commands()`.
- R4: `_deploy_classic()` MUST continue to work unchanged (default prefix = `~/.claude/skills`).
- R5: The rewriting MUST replace all occurrences of `~/.claude/skills/` in SKILL.md content, command content, and inlined CLAUDE.md content.
- R6: Existing tests MUST continue to pass.
- R7: The fix MUST NOT change the template strings themselves — only the deployer logic.

## Acceptance Criteria

### Scenario 1: Classic mode unchanged
- **Given** PactKit is deployed via `pactkit init` (classic mode)
- **When** inspecting deployed `skills/pactkit-visualize/SKILL.md`
- **Then** it contains `~/.claude/skills/pactkit-visualize/scripts/visualize.py`

### Scenario 2: Plugin mode uses CLAUDE_PLUGIN_ROOT
- **Given** PactKit is deployed via `pactkit init --format plugin`
- **When** inspecting deployed `skills/pactkit-visualize/SKILL.md`
- **Then** it contains `${CLAUDE_PLUGIN_ROOT}/skills/pactkit-visualize/scripts/visualize.py`
- **And** it does NOT contain `~/.claude/skills/`

### Scenario 3: Plugin commands use CLAUDE_PLUGIN_ROOT
- **Given** PactKit is deployed via `pactkit init --format plugin`
- **When** inspecting deployed `commands/project-act.md`
- **Then** all `python3 ` script invocations use `${CLAUDE_PLUGIN_ROOT}/skills/`
- **And** no `~/.claude/skills/` references remain

### Scenario 4: Marketplace mode (transitive)
- **Given** PactKit is deployed via `pactkit init --format marketplace`
- **When** inspecting deployed `pactkit-plugin/skills/pactkit-visualize/SKILL.md`
- **Then** it contains `${CLAUDE_PLUGIN_ROOT}/skills/` (same as plugin mode)

## Affected Files

| File | Change |
|------|--------|
| `src/pactkit/generators/deployer.py` | Add `skills_prefix` parameter to `_deploy_skills()` and `_deploy_commands()`, pass from `_deploy_plugin()` |
